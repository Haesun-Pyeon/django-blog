{% load django_bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://kit.fontawesome.com/67cab5a85c.js" crossorigin="anonymous"></script>
</head>
<body>
    <h1>detail</h1>
    <nav>
        <ul>
            <li><a href="#">Home</a></li>
            <li><a href="#">Blog</a></li>
            <li><a href="#">About</a></li>
        </ul>
    </nav>
    <main id="main">
    <p>{{ post.title }}</p>
    <div class='like'>
        <i id='heart-post' onclick='sendRequest({{ post.id }}, true)' class="{% if user in post.like.all %} fa-solid {% else %} fa-regular {% endif %} fa-heart"></i>
        <span id='like-count'>{{ post.like.count }}</span>
    </div>
    <p>{{ post.content | safe }}</p>
    <p>{{ post.created_at }}</p>
    <p>by {{ post.author }}</p>
    <p>조회수: {{ post.view_count }}</p>
    <p>
        {% for t in post.tags.all %}
        <a href="{% url 'tag' t.slug %}">#{{t.name}}</a>
        {% endfor %}
    </p>

    {% if user == post.author %}
    <button class='btn btn-primary' onclick="location.href='{% url 'post_edit' post.pk %}'">수정</button>
    <!-- Button that opens a modal -->
    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#delete_item">
        삭제
    </button>

    <!-- Modal -->
    <div class="modal fade" id="delete_item" data-bs-backdrop="static"
        data-bs-keyboard="false" tabindex="-1" aria-labelledby="delete_item_label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="delete_item_label">글 삭제</h5>
            </div>

            <form action="{% url 'post_delete' post.pk %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <p>정말로 이 글을 삭제하시겠습니까?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-danger" value="Confirm">삭제</button>
                </div>
            </form>
            </div>
        </div>
    </div>
    {% endif %}

    {% if post.comments.exists %}
        <h2>댓글</h2>
        {% for comment in post.comments.all %}
            <p>{{ comment.content | linebreaks }}</p>
            <p>{{ comment.created_at }}</p>
            <p>by {{ comment.author }}</p>
            {% if user.is_authenticated and comment.author == user %}
            <a role="button" href="/blog/comment-edit/{{comment.pk}}">수정</a>
            <a role="button" href="/blog/comment-del/{{comment.pk}}">삭제</a>
            {% endif %}

            <div class='like'>
                <i id='heart-comment-{{ comment.id }}' onclick='sendRequest({{ comment.id }}, false)' class="{% if user in comment.like.all %} fa-solid {% else %} fa-regular {% endif %} fa-heart"></i>
                <span id='like-count-{{ comment.id }}'>{{ comment.like.count }}</span>
            </div>
        
            <hr>
        {% endfor %}
    {% else %}
        <p>아직 댓글이 없습니다.</p>
    {% endif %}
    {% if user.is_authenticated %}
    <form id="comment-form" action="{{post.get_absolute_url}}comment-new/" method="post">
        {% csrf_token %}
        {% bootstrap_form comment_form %}
        <button type="submit" class='btn btn-primary'>댓글작성</button>
    </form>
    {% endif %}

    <button class='btn btn-primary' onclick="location.href='{% url 'post_list' %}'">목록</button>

    <script>
        function sendRequest(id, isPost) {
            const httpRequest = new XMLHttpRequest();
            httpRequest.onreadystatechange = function(){
                if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200){
                    const jsonResponse = JSON.parse(httpRequest.responseText);
                    if (isPost){
                        document.querySelector('#like-count').innerHTML = jsonResponse['likeCount'];
                        var $heart = document.querySelector('#heart-post')
                    } else {
                        document.querySelector('#like-count-'+id).innerHTML = jsonResponse['likeCount'];
                        var $heart = document.querySelector('#heart-comment-'+id)
                    }
                    if (jsonResponse['isLikeNow']) {
                        $heart.classList.remove("fa-regular");
                        $heart.classList.add("fa-solid");
                    } else {
                        $heart.classList.add("fa-regular");
                        $heart.classList.remove("fa-solid");                        
                    }
                }
            };
            if (isPost){
                httpRequest.open('GET', "{% url 'post_like' post.id %}", true);
            } else {
                httpRequest.open('GET', "/blog/comment-like/"+id, true);
            }
            httpRequest.send();
        }
    </script>
    </main>
</body>
</html>
{% extends "base.html" %}
{% load django_bootstrap5 %}
{% load static %}

{% block head %}
<script src="https://kit.fontawesome.com/67cab5a85c.js" crossorigin="anonymous"></script>
{% endblock head %}

{% block title %}
<h1>글 상세보기</h1>
{% endblock title %}

{% block content %}
    <main id="main">
    <p>{{ post.title }}</p>
    <div class='like'>
        <i id='heart-post' onclick='sendLikeRequest({{ post.id }}, true)' class="{% if user in post.like.all %} fa-solid {% else %} fa-regular {% endif %} fa-heart"></i>
        <span id='like-count'>{{ post.like.count }}</span>
    </div>
    {% if post.head_image %}
    <img src={{ post.head_image.url }} class="img-fluid img-thumbnail my-3" width="400px" alt="post">
    {% else %}
    <img src="{% static 'images/post.jpg' %}" class="img-fluid img-thumbnail my-3" width="400px" alt="post">
    {% endif %}
    {% comment %} detail에도 넣을지말지??? {% endcomment %}

    <p>{{ post.content | safe }}</p>
    <p>{{ post.created_at }}</p>
    <p>by {{ post.author }}</p>
    <p>조회수: {{ post.view_count }}</p>
    <p>
        {% for t in post.tags.all %}
        <a href="{% url 'tag' t.slug %}">#{{t.name}}</a>
        {% endfor %}
    </p>

    {% if user == post.author %}
    <button class='btn btn-primary' onclick="location.href='{% url 'post_edit' post.pk %}'">수정</button>
    <!-- Button that opens a modal -->
    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#delete_item">
        삭제
    </button>

    <!-- Modal -->
    <div class="modal fade" id="delete_item" data-bs-backdrop="static"
        data-bs-keyboard="false" tabindex="-1" aria-labelledby="delete_item_label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="delete_item_label">글 삭제</h5>
            </div>

            <form action="{% url 'post_delete' post.pk %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <p>정말로 이 글을 삭제하시겠습니까?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-danger" value="Confirm">삭제</button>
                </div>
            </form>
            </div>
        </div>
    </div>
    {% endif %}

    {% if post.comments.exists %}
        <h2>댓글</h2>
        {% for comment in post.comments.all %}
            <p>{{ comment.content | linebreaks }}</p>
            <p>{{ comment.created_at }}</p>
            <p>by {{ comment.author }}</p>
            {% if user.is_authenticated and comment.author == user %}
            <form id='del' action="{% url 'comment_del' comment.pk %}" method="post">
                {% csrf_token %}
                <a href="javascript:showEdit({{comment.pk}}, '{{ comment.content }}');">수정</a>
                <a href="javascript:document.querySelector('#del').submit();">삭제</a>
            </form>
            {% endif %}

            <div id="comment-form-{{comment.pk}}", style='display:none;'>
                <form action="{% url 'comment_edit' comment.pk %}" method="post">
                    {% csrf_token %}
                    {% bootstrap_form comment_form %}
                    <button type="submit" class='btn btn-primary'>완료</button>
                    <button type="button" onclick='hideEdit({{ comment.pk }});' class='btn btn-secondary'>닫기</button>
                </form>
            </div>

            <div class='like'>
                <i id='heart-comment-{{ comment.id }}' onclick='sendLikeRequest({{ comment.id }}, false)' class="{% if user in comment.like.all %} fa-solid {% else %} fa-regular {% endif %} fa-heart"></i>
                <span id='like-count-{{ comment.id }}'>{{ comment.like.count }}</span>
            </div>
        
            <hr>
        {% endfor %}
    {% else %}
        <p>아직 댓글이 없습니다.</p>
    {% endif %}
    {% if user.is_authenticated %}
    <form id="comment-form" action="{% url 'comment_new' post.id %}" method="post">
        {% csrf_token %}
        {% bootstrap_form comment_form %}
        <button type="submit" class='btn btn-primary'>댓글작성</button>
    </form>
    {% endif %}

    <button class='btn btn-primary' onclick="location.href='{% url 'post_list' %}'">목록</button>

    <script>
        function sendLikeRequest(id, isPost) {
            const httpRequest = new XMLHttpRequest();
            httpRequest.onreadystatechange = function(){
                if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200){
                    const jsonResponse = JSON.parse(httpRequest.responseText);
                    if (isPost){
                        document.querySelector('#like-count').innerHTML = jsonResponse['likeCount'];
                        var $heart = document.querySelector('#heart-post')
                    } else {
                        document.querySelector('#like-count-'+id).innerHTML = jsonResponse['likeCount'];
                        var $heart = document.querySelector('#heart-comment-'+id)
                    }
                    if (jsonResponse['isLikeNow']) {
                        $heart.classList.remove("fa-regular");
                        $heart.classList.add("fa-solid");
                    } else {
                        $heart.classList.add("fa-regular");
                        $heart.classList.remove("fa-solid");                        
                    }
                }
            };
            if (isPost){
                httpRequest.open('GET', "{% url 'post_like' post.id %}", true);
            } else {
                httpRequest.open('GET', "/blog/comment-like/"+id, true);
            }
            httpRequest.send();
        }

        function showEdit(id, content){
            const $form = document.querySelector('#comment-form-'+id)
            $form.style.display = 'block'
            $form.querySelector('.form-control').innerText = content
        }

        function hideEdit(id){
            const $form = document.querySelector('#comment-form-'+id)
            $form.style.display = 'none'
        }
    </script>
    </main>
{% endblock content %}